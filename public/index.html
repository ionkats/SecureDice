<html>

<head>
  <title>Cryptographically secure dices</title>
  <link rel="stylesheet" href="/stylesheets/style.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.0.0/crypto-js.min.js"></script>
</head>

<body>
  <div class="main">
    <h1 class="heading">Cryptographically Secure Dices</h1>
    <div class="left-column">
      <div class="values">
        User's dice <div class="value" id="user"> - </div>
        Server's dice <div class="value" id="server"> - </div>
      </div> 
    </div>
    <div class="right-column">
      <h3>Winner: </h3><div class="value" id="winner-value"> - </div>
    </div>
    <div class="play-game">
        <button class="play btn" id="play-button">Play</button>
      </div>
    </div>
    
 


  <script>
    const playButton = document.getElementById("play-button");
    
    function addUiListener(){
      playButton.addEventListener("click",clientInit);
    }
    addUiListener()

    let r1;
    let s1;
    let s2;
    let userDice = "-";
    let serverDice = "-";

    function typedArrayToHex(typedArr) {
      // https://stackoverflow.com/a/50767210
      return Array.from(typedArr)
        .map(b => b.toString(16).padStart(2, "0"))
        .join("");
    }
    
    function clientInit() {
      const randomBytes = new Uint8Array(16);
      crypto.getRandomValues(randomBytes);
      r1 = typedArrayToHex(randomBytes) + Date.now();
      s1 = CryptoJS.SHA256(r1);
      callServerInitiate(s1);
    }

    async function callServerInitiate(s1) {
      fetch(`/api/initiate?s1=${s1}`, {method: 'POST'})
        .then(response => response.json())
        .then(data => receiveS2(data.s2));

      // const response = await fetch(`/api/initiate?s1=${s1}`);
      // const data = await response.json();
      // receiveS2(data.s2);
    }

    function callServerFinalize(r1) {
      fetch(`/api/finalize?r1=${r1}`, {method: 'POST'})
        .then(response => response.json())
        .then(data => receiveR2(data.r2, data.serverDice))
    }

    function receiveS2(_s2) {
      s2 = _s2
      callServerFinalize(r1);
    }

    function receiveR2(r2, _serverDice) {
      const h = CryptoJS.SHA256(r2);
      if (h==s2){
        try {
          // Add the second byte of r1 and r2 and get the dice of the server from them
          const secondR1 = Number.parseInt(r1.substr(2, 2), 16);
          const secondR2 = Number.parseInt(r2.substr(2, 2), 16);
          const firstR1 = Number.parseInt(r1.substr(0, 2), 16);
          const firstR2 = Number.parseInt(r2.substr(0, 2), 16);
          serverDice = (firstR1 + firstR2) % 6 + 1; 
          if (serverDice!=_serverDice){
            alert("Server not trustworthy.");
          }
          userDice = (secondR1 + secondR2) % 6 + 1; 
        } catch (_e) {
          return alert("Received invalid parameter from server");
        }
        // alert("User dice = "+userDice+" Server dice = "+serverDice);
        if (serverDice>userDice){
          winnerValue = "Server";
        }else if(serverDice<userDice){
          winnerValue = "User";
        }else{
          winnerValue = "It's a tie";
        }
        document.getElementById("user").innerHTML = userDice;
        document.getElementById("server").innerHTML = serverDice;
        document.getElementById("winner-value").innerHTML = winnerValue;
      }else{
        alert("Server not trustworthy.");
      }
    }

    


  </script>
</body>

</html>
